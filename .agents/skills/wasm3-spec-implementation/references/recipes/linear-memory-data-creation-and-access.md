# Linear Memory Data Creation and Access

## Use When

Use this when your language should store most runtime values in linear memory with predictable offsets and low-overhead access patterns.

## Core Design Goals

- deterministic layout for every public data type within a chosen ABI profile/version
- constructor/accessor operations generated by compiler
- explicit ownership/lifetime for pointers and slices
- stable ABI across modules and host boundaries

## Canonical Data Header Pattern

For heap-allocated values, use a small fixed header:

- `type_id` or constructor tag
- payload byte length
- flags (ownership, mutability, pinned)
- optional inline metadata (arity, hash, refcount/mark bits)

Keep field order fixed and versioned.

## Creation Pattern

1. Compute total size from static layout metadata.
2. Allocate contiguous block (arena/heap).
3. Write header first, then payload fields at fixed offsets.
4. Return pointer handle with explicit ownership mode.
5. Validate alignment in debug builds.

## Access Pattern

1. Validate tag/type id before projection.
2. Compute field offset from generated layout table.
3. Load/store using typed helpers (`load_i32`, `load_f64`, etc.).
4. Avoid ad-hoc pointer arithmetic in user codegen.
5. Keep bounds checks at ABI and FFI boundaries.

## Layout Strategies

1. AoS (array of structs):
- simple and locality-friendly for whole-object traversal

2. SoA (struct of arrays):
- better SIMD/cache behavior for per-field scans

3. Hybrid:
- fixed inline fields + pointer to variable tail data

Choose per workload, not globally.
For public cross-module types, expose one canonical layout per ABI profile and version.

## Common Pitfalls

- field offset drift between compiler and runtime
- hidden padding differences not documented in ABI
- pointer invalidation across allocator/memory growth assumptions
- mixing borrowed and owned pointers without checks

## Pointers

- Packing/versioning rules: `references/recipes/packing-and-unpacking.md`
- Ownership/lifetimes: `references/recipes/lifetime-and-escape-analysis.md`
- JS/host transport: `references/recipes/javascript-data-marshalling.md`
