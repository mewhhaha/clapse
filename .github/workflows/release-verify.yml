name: release-verify

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Manual release tag (defaults to v<VERSION>)"
        required: false
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup just
        uses: extractions/setup-just@v1

      - name: Bootstrap compiler from kernel
        env:
          CLAPSE_BOOTSTRAP_COMPILER_WASM_PATH: artifacts/latest/clapse_compiler.wasm
        run: just bootstrap-compiler

      - name: Run pre-tag verification
        env:
          CLAPSE_COMPILER_WASM_PATH: artifacts/latest/clapse_compiler.wasm
        run: just pre-tag-verify

      - name: Resolve release context
        id: release_context
        run: |
          set -euo pipefail
          version="$(cat VERSION)"
          short_sha="$(git rev-parse --short=12 HEAD)"
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            release_tag="${{ inputs.release_tag }}"
            if [[ -z "${release_tag}" ]]; then
              release_tag="v${version}"
            fi
          else
            release_tag="${GITHUB_REF_NAME}"
          fi
          if [[ "${release_tag}" != v* ]]; then
            echo "release tag must start with 'v' (got: ${release_tag})" >&2
            exit 1
          fi
          release_id="${release_tag}-${short_sha}"
          release_dir="out/releases-ci/${release_id}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "release_id=${release_id}" >> "$GITHUB_OUTPUT"
          echo "release_dir=${release_dir}" >> "$GITHUB_OUTPUT"

      - name: Prepare wasm + CLI release bundle
        id: release_bundle
        env:
          RELEASE_DIR: ${{ steps.release_context.outputs.release_dir }}
          RELEASE_ID: ${{ steps.release_context.outputs.release_id }}
          RELEASE_TAG: ${{ steps.release_context.outputs.release_tag }}
          CLAPSE_VERSION: ${{ steps.release_context.outputs.version }}
        run: |
          set -euo pipefail
          for path in \
            artifacts/latest/clapse_compiler.wasm \
            artifacts/latest/seed-lock.json \
            scripts/wasm-behavior-fixture-map.json \
            scripts/wasm-selfhost-artifact-fixture-map.json \
            lib/compiler/prelude.clapse
          do
            if [ ! -f "${path}" ]; then
              echo "missing required release input: ${path}" >&2
              exit 1
            fi
          done

          seed_release_id="$(deno eval 'const lock = JSON.parse(await Deno.readTextFile("artifacts/latest/seed-lock.json")); console.log(lock.seed_release_id ?? "");')"
          seed_compiler_sha_expected="$(deno eval 'const lock = JSON.parse(await Deno.readTextFile("artifacts/latest/seed-lock.json")); console.log(lock.compiler_wasm_sha256 ?? "");')"
          seed_manifest_release_id="$(deno eval 'const m = JSON.parse(await Deno.readTextFile("artifacts/latest/release-manifest.json")); console.log(m.release_id ?? "");')"
          seed_compiler_sha_actual="$(sha256sum artifacts/latest/clapse_compiler.wasm | awk '{print $1}')"
          if [ -z "${seed_release_id}" ] || [ -z "${seed_compiler_sha_expected}" ]; then
            echo "invalid seed lock file: artifacts/latest/seed-lock.json" >&2
            exit 1
          fi
          if [ "${seed_release_id}" != "${seed_manifest_release_id}" ]; then
            echo "seed lock release id mismatch: lock=${seed_release_id} manifest=${seed_manifest_release_id}" >&2
            exit 1
          fi
          if [ "${seed_compiler_sha_actual}" != "${seed_compiler_sha_expected}" ]; then
            echo "seed compiler checksum drift: expected=${seed_compiler_sha_expected} actual=${seed_compiler_sha_actual}; continuing with current verified compiler wasm" >&2
          fi
          echo "seed lock verified (${seed_release_id})"

          mkdir -p "${RELEASE_DIR}"
          [ -s "artifacts/latest/clapse_compiler.wasm" ] || { echo "missing compiler source wasm: artifacts/latest/clapse_compiler.wasm" >&2; exit 1; }
          [ -s "artifacts/latest/clapse_compiler.d.ts" ] || { echo "missing compiler source d.ts: artifacts/latest/clapse_compiler.d.ts" >&2; exit 1; }
          deno run -A scripts/check-browser-compiler-wasm.mjs --wasm "artifacts/latest/clapse_compiler.wasm"
          cp artifacts/latest/clapse_compiler.wasm "${RELEASE_DIR}/clapse_compiler.wasm"
          cp artifacts/latest/clapse_compiler.d.ts "${RELEASE_DIR}/clapse_compiler.d.ts"
          deno run -A scripts/check-browser-compiler-wasm.mjs --wasm "${RELEASE_DIR}/clapse_compiler.wasm"
          deno compile -A --output "${RELEASE_DIR}/clapse-bin" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin"
          deno compile -A --target x86_64-unknown-linux-gnu --output "${RELEASE_DIR}/clapse-bin-linux-x64" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin-linux-x64"
          deno compile -A --target aarch64-unknown-linux-gnu --output "${RELEASE_DIR}/clapse-bin-linux-arm64" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin-linux-arm64"
          deno compile -A --target x86_64-apple-darwin --output "${RELEASE_DIR}/clapse-bin-macos-x64" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin-macos-x64"
          deno compile -A --target aarch64-apple-darwin --output "${RELEASE_DIR}/clapse-bin-macos-arm64" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin-macos-arm64"
          deno compile -A --target x86_64-pc-windows-msvc --output "${RELEASE_DIR}/clapse-bin-win-x64.exe" scripts/clapse.mjs
          chmod +x "${RELEASE_DIR}/clapse-bin-win-x64.exe"
          cp lib/compiler/prelude.clapse "${RELEASE_DIR}/prelude.clapse"
          cp scripts/wasm-behavior-fixture-map.json "${RELEASE_DIR}/wasm-behavior-fixture-map.json"
          cp scripts/wasm-selfhost-artifact-fixture-map.json "${RELEASE_DIR}/wasm-selfhost-artifact-fixture-map.json"

          cat > "${RELEASE_DIR}/clapse" <<EOF
          #!/usr/bin/env bash
          set -euo pipefail
          SELF_DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
          export CLAPSE_COMPILER_WASM_PATH="\${CLAPSE_COMPILER_WASM_PATH:-\${SELF_DIR}/clapse_compiler.wasm}"
          exec deno run -A "https://raw.githubusercontent.com/mewhhaha/clapse/${RELEASE_TAG}/scripts/clapse.mjs" --wasm "\$@"
          EOF
          chmod +x "${RELEASE_DIR}/clapse"

          deno run -A scripts/release-metadata.mjs \
            --release-id "${RELEASE_ID}" \
            --clapse-version "${CLAPSE_VERSION}" \
            --compiler-wasm "${RELEASE_DIR}/clapse_compiler.wasm" \
            --compiler-dts "${RELEASE_DIR}/clapse_compiler.d.ts" \
            --cli-bin "${RELEASE_DIR}/clapse-bin" \
            --cli-bin "${RELEASE_DIR}/clapse-bin-linux-x64" \
            --cli-bin "${RELEASE_DIR}/clapse-bin-linux-arm64" \
            --cli-bin "${RELEASE_DIR}/clapse-bin-macos-x64" \
            --cli-bin "${RELEASE_DIR}/clapse-bin-macos-arm64" \
            --cli-bin "${RELEASE_DIR}/clapse-bin-win-x64.exe" \
            --behavior-map "${RELEASE_DIR}/wasm-behavior-fixture-map.json" \
            --artifact-map "${RELEASE_DIR}/wasm-selfhost-artifact-fixture-map.json" \
            --prelude-source "${RELEASE_DIR}/prelude.clapse" \
            --out "${RELEASE_DIR}/release-manifest.json" \
            --checksums "${RELEASE_DIR}/checksums.sha256"

      - name: Upload release candidate artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clapse-release-candidate-${{ github.sha }}
          path: ${{ steps.release_context.outputs.release_dir }}
          if-no-files-found: error

      - name: Create and push release tag
        if: github.event_name == 'workflow_dispatch'
        env:
          RELEASE_TAG: ${{ steps.release_context.outputs.release_tag }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git rev-parse -q --verify "refs/tags/${RELEASE_TAG}" >/dev/null; then
            echo "release tag already exists: ${RELEASE_TAG}" >&2
            exit 1
          fi
          git tag -a "${RELEASE_TAG}" -m "clapse ${RELEASE_TAG}"
          git push origin "refs/tags/${RELEASE_TAG}"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_context.outputs.release_tag }}
          name: clapse ${{ steps.release_context.outputs.release_tag }}
          fail_on_unmatched_files: true
          generate_release_notes: true
          body: |
            Verified wasm + CLI release artifacts for `${{ steps.release_context.outputs.release_id }}`.
            Check `checksums.sha256` for artifact integrity.
          files: |
            ${{ steps.release_context.outputs.release_dir }}/clapse
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin-linux-x64
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin-linux-arm64
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin-macos-x64
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin-macos-arm64
            ${{ steps.release_context.outputs.release_dir }}/clapse-bin-win-x64.exe
            ${{ steps.release_context.outputs.release_dir }}/clapse_compiler.wasm
            ${{ steps.release_context.outputs.release_dir }}/clapse_compiler.d.ts
            ${{ steps.release_context.outputs.release_dir }}/prelude.clapse
            ${{ steps.release_context.outputs.release_dir }}/wasm-behavior-fixture-map.json
            ${{ steps.release_context.outputs.release_dir }}/wasm-selfhost-artifact-fixture-map.json
            ${{ steps.release_context.outputs.release_dir }}/release-manifest.json
            ${{ steps.release_context.outputs.release_dir }}/checksums.sha256
